name: Manage Renovate pull requests

on:
  workflow_dispatch:
    inputs:
      job_name:
        description: 'A job name'
        required: true
        type: choice
        options:
        - prune-pull-requests
        - execute-renovate
  # schedule:
  #   - cron: '0 * * * *' # hourly

run-name: "Manage Renovate PRs by ${{ github.actor }} - ${{ github.event_name }}"

permissions: {}

jobs:
  # Prune pull requests and branches that have failures
  prune-pull-requests:
    if: >
      github.event_name == 'schedule' ||
      inputs.job_name == 'prune-pull-requests'

    timeout-minutes: 5

    permissions:
      issues: read # search pull requests (issues)
      contents: write # for deleting branches
      pull-requests: write # for closing pull requests

    runs-on: ubuntu-latest

    steps:
    - uses: suzuki-shunsuke/renovate-autoclose-action@f018be0c1770e0825d7d0aa7aaec3f6ead33b069

  execute-renovate:
    if: >
      inputs.job_name == 'execute-renovate'
    
    timeout-minutes: 5

    permissions:
      contents: read

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3
      - name: Self-hosted Renovate
        uses: renovatebot/github-action@81cd2edbb5fd1dc42115b0d1c8854d5a6b74d835 # v36.0.3
        with:
          configurationFile: renovate.json
          token: ${{ secrets.RENOVATE_TEST_TOKEN }}
        env:
          LOG_LEVEL: 'debug'
          RENOVATE_REPOSITORIES: ${{ github.repository }}